name: Coverage Tests

on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:
    branches:
      - "**"

jobs:
  test-coverage:
    name: Run Tests with Coverage
    runs-on: ubuntu-latest
    env:
      # Disable implicitly syncing before running - we run an explicit sync first.
      UV_NO_SYNC: true

    steps:
      # Step 1: Check out the repository
      - name: Checkout code
        uses: actions/checkout@v6

      # Step 2: Setup uv and python
      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
            python-version: 3.12

      # Step 3: Install dependencies
      - name: Install dependencies and test group
        run: uv sync --no-dev --group test --all-extras

      # Step 4: Run tests and capture coverage > generates .coverage
      - name: Run tests with coverage
        run: |
          uv run coverage run -m pytest

      # Step 5: Display coverage in logs
      - name: Display coverage report
        run: |
          uv run coverage report -m  # Show full detailed coverage in logs